<!DOCTYPE html>
<html lang="fr" style="margin:0;padding:0;width:100%;height:100%;">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Facture {{ invoice.invoice_number }} avec Garantie</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

        :root {
            --primary-color: #2c3e50;
            --secondary-color: #34495e;
            --accent-color: #3498db;
            --text-primary: #2c3e50;
            --text-secondary: #7f8c8d;
            --border-color: #ecf0f1;
            --bg-light: #f8f9fa;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        html, body {
            margin: 0 !important; padding: 0 !important; width: 100% !important; min-height: 100vh !important; background-color: #f5f5f5;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; line-height: 1.6; font-size: 11pt; color: var(--text-primary); display: flex; flex-direction: column; align-items: center; min-height: 100vh;
        }

        .page-controls { position: fixed; top: 20px; left: 0; right: 0; display: flex; justify-content: center; gap: 10px; z-index: 1000; }
        .page-controls .btn { padding: 8px 16px; border-radius: 4px; font-weight: 600; font-size: 14px; box-shadow: 0 2px 5px rgba(0,0,0,0.15); display: flex; align-items: center; gap: 8px; }
        .btn-print { background-color: var(--primary-color); color: #fff; border: none; }
        .btn-download { background-color: #27ae60; color: #fff; border: none; }
        .btn-return { background-color: var(--secondary-color); color: #fff; border: none; }

        .page-container { display: flex; justify-content: center; align-items: center; padding: 80px 0 0; min-height: 100vh; width: 100%; box-sizing: border-box; }

        @media print {
            html, body { width: 210mm; height: auto; margin: 0 !important; padding: 0 !important; overflow: visible; }
            .page-container { padding: 0 !important; margin: 0 !important; width: 210mm; height: auto; }
            #invoice-container { margin: 0 !important; padding: 0 !important; border: none !important; box-shadow: none !important; width: 210mm !important; height: auto !important; transform: none !important; min-height: 297mm !important; }
            .no-print { display: none !important; }
            @page { 
                size: A4; 
                margin: 6mm 10mm 8mm 10mm; /* marges plus homogènes pour éviter les débordements */
            }
            .products { 
                page-break-inside: auto; 
                margin-top: 0 !important;
                padding-top: 0 !important;
            }
            .product-row { 
                page-break-inside: avoid; 
                break-inside: avoid; 
            }
            .totals { page-break-before: avoid; break-before: avoid; }
            /* IMPORTANT: ne pas utiliser de footer fixe pour éviter qu'il n'apparaisse sur la page certificat */
            .footer { 
                position: static !important;
                width: auto; 
                height: auto; 
                padding: 6px 0; 
                margin: 8mm 10mm 0 10mm !important;
                background: #f8f9fa; 
                border-top: 1px solid #e0e0e0;
                box-sizing: border-box;
            }
            .warranty-page {
                page-break-before: always !important;
                break-before: always !important;
                /* Empêcher la coupure sur 2 pages */
                page-break-inside: avoid !important;
                break-inside: avoid-page !important;
            }
        }

        .container-a4 { width: 210mm !important; max-width: 210mm !important; min-height: 297mm !important; margin: 0 !important; padding: 0 !important; background-color: #fff !important; box-shadow: 0 5px 15px rgba(0,0,0,0.08); overflow: visible; display: flex; flex-direction: column; position: relative; }

        .header { background: #fff; padding: 35px 32px 22px; border-bottom: 1px solid #ddd; display: flex; justify-content: space-between; align-items: flex-start; width: 100%; }
        .logo-section { display: flex; align-items: center; gap: 16px; }
        .logo { max-width: 150px; max-height: 150px; object-fit: contain; }
        .company-info h1 { font-size: 22px; font-weight: 800; margin: 0; color: #111; }
        .company-info p { margin: 2px 0; font-size: 12px; color: var(--text-secondary); }
        .company-info { display: flex; flex-direction: column; justify-content: center; }
        .invoice-info { text-align: right; }
        .invoice-title { font-size: 28px; font-weight: 300; color: var(--text-secondary); margin: 0 0 6px 0; }
        .invoice-number { font-size: 16px; font-weight: 600; color: var(--primary-color); margin: 0 0 6px 0; }
        .invoice-date { font-size: 13px; color: var(--text-secondary); margin: 0; }

        .billing { display: flex; padding: 16px 24px; gap: 24px; background-color: #fff; border-bottom: 1px solid var(--border-color); margin: 0 20px; }
        .section-title { font-size: 11px; font-weight: 700; text-transform: uppercase; color: var(--text-secondary); margin-bottom: 8px; letter-spacing: .5px; border-bottom: 2px solid var(--accent-color); padding-bottom: 6px; display: inline-block; }
        .client-details p { margin: 4px 0; font-size: 13px; color: var(--text-primary); }
        .payment-box { background: var(--bg-light); padding: 16px; border-radius: 6px; border: 1px solid var(--border-color); }

        .products { flex: 1; display: flex; flex-direction: column; width: calc(100% - 60px); margin: 16px 30px 0; background: #fff; border-radius: 0; overflow: hidden; }
        .products-header { display: grid; grid-template-columns: 1fr 80px 120px 120px; background: #f8f9fa; padding: 12px 16px; font-size: 12px; font-weight: 600; color: #333; text-transform: uppercase; border: 1px solid #ddd; border-bottom: 2px solid #333; }
        .product-row { display: grid; grid-template-columns: 1fr 80px 120px 120px; padding: 12px 16px; border-bottom: 1px solid #eee; }
        .product-name { font-weight: 500; font-size: 13px; color: var(--text-primary); padding-right: 12px; }
        .product-qty, .product-price, .product-total { text-align: right; font-size: 13px; }
        .imei { color: #666; font-size: 11px; margin-top: 4px; }
        .product-desc { color: #777; font-size: 10px; margin-top: 3px; text-align: justify; }

        .totals { margin: 12px 24px 0; display: flex; justify-content: flex-end; }
        .totals-card { min-width: 320px; max-width: 360px; background: #fff; border: 1px solid #e5e7eb; border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,.05); padding: 14px 16px; }
        .totals-header { font-size: 11px; text-transform: uppercase; letter-spacing: .6px; color: var(--text-secondary); margin-bottom: 8px; }
        .totals-row { display: flex; align-items: center; justify-content: space-between; padding: 6px 0; }
        .totals-row + .totals-row { border-top: 1px dashed #e5e7eb; }
        .totals-label { color: #6b7280; font-size: 12px; }
        .totals-value { color: #2563eb; font-weight: 700; font-variant-numeric: tabular-nums; }
        .totals-row.grand { border-top: 2px solid #d1d5db; margin-top: 4px; padding-top: 10px; }
        .totals-row.grand .totals-label { color: #111827; font-weight: 700; }
        .totals-row.grand .totals-value { color: #111827; font-size: 15px; }

        .footer { padding: 16px 28px; border-top: 1px solid #e0e0e0; font-size: 11px; width: 100%; margin-top: auto; background: #f8f9fa; }
        .footer-content { display: flex; justify-content: space-between; gap: 16px; }
        .footer-section h4 { font-size: 12px; font-weight: 600; color: #333; margin: 0 0 6px 0; text-transform: uppercase; }
        .footer-section p { margin: 2px 0; color: #666; font-size: 11px; }
        
        /* Footer fixe pour l'impression */
        @media print {
            .footer-content { 
                display: flex; 
                justify-content: space-between; 
                gap: 15px; 
                align-items: center;
                height: 100%;
                padding: 0;
            }
            .footer-section { 
                text-align: center; 
                flex: 1; 
            }
            .footer-section h4 { 
                font-size: 10px; 
                font-weight: 600; 
                color: #333; 
                margin: 0 0 3px 0; 
                text-transform: uppercase; 
            }
            .footer-section p { 
                margin: 0; 
                color: #666; 
                font-size: 9px; 
                line-height: 1.3;
            }
        }
        .products { page-break-inside: auto; }
        .product-row { page-break-inside: avoid; break-inside: avoid; }
        .totals { page-break-before: avoid; break-before: avoid; }
        .footer { page-break-inside: avoid; break-inside: avoid; }

        .text-end { text-align: right; }

        /* Styles pour la page de garantie - Design moderne */
        .warranty-page {
            width: 210mm !important; 
            max-width: 210mm !important; 
            height: 297mm !important; /* Forcer A4 exact */
            margin: 0 !important; 
            padding: 12mm 12mm 10mm 12mm !important; /* marges compactes pour rester sur 1 page */
            background-color: #fff !important; 
            box-shadow: none; 
            display: flex; 
            flex-direction: column; 
            justify-content: flex-start; 
            align-items: stretch; 
            text-align: left;
            position: relative;
            overflow: hidden; /* Empêcher le débordement sur 2e page */
        }

        /* Filigrane logo au centre */
        .w-watermark {
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0.06; /* au-dessus des cartes mais très léger */
            pointer-events: none;
            user-select: none;
            z-index: 10; /* au-dessus des tuiles */
            -webkit-print-color-adjust: exact;
            print-color-adjust: exact;
            mix-blend-mode: multiply;
        }
        .w-watermark img { max-width: 70%; max-height: 70%; object-fit: contain; filter: grayscale(100%); }

        /* S'assurer que le contenu passe au-dessus du filigrane */
        .warranty-hero, .card, .warranty-content, .warranty-footer { position: relative; z-index: 1; }

        /* Bandeau en-tête moderne */
        .warranty-hero {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(135deg, #eef2ff 0%, #f8fafc 100%);
            border: 1px solid #e5e7eb;
            padding: 10mm;
            border-radius: 8px;
            margin-bottom: 8mm;
        }
        .w-identity { display: flex; align-items: center; gap: 10px; }
        .w-identity .brand { font-size: 16px; font-weight: 800; color: #111; }
        .w-identity .address { font-size: 10px; color: #6b7280; }
        .warranty-title { font-size: 22px; font-weight: 700; color: var(--primary-color); margin: 0; text-transform: uppercase; letter-spacing: .8px; }
        .badge-chip {
            background: #1f2937;
            color: #fff;
            padding: 6px 10px;
            border-radius: 999px;
            font-size: 11px;
            font-weight: 600;
            box-shadow: 0 2px 4px rgba(0,0,0,.06);
            white-space: nowrap;
        }

        .warranty-section-title {
            font-size: 12px;
            font-weight: 700;
            color: var(--primary-color);
            text-transform: uppercase;
            letter-spacing: .5px;
            margin: 0 0 4mm 0;
        }

        .card {
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 6mm;
            background: #ffffff;
        }

        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 6mm; }
        .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 5mm; }

        .keyline { border-top: 1px solid #e5e7eb; margin: 5mm 0; }

        .muted { color: #6b7280; }
        .small { font-size: 10px; }

        .warranty-content {
            max-width: 182mm;
            margin: 0;
            line-height: 1.55;
            font-size: 11px;
        }
        .warranty-content h3 { font-size: 13px; font-weight: 700; color: var(--primary-color); margin: 5mm 0 3mm; }
        .warranty-content p { margin: 0 0 3mm 0; text-align: justify; }
        .warranty-content ul { margin: 0 0 3mm 16px; padding: 0; }
        .warranty-content li { margin: 0 0 2mm 0; }

        .warranty-info { background: #f9fafb; padding: 6mm; border: 1px solid #e5e7eb; border-radius: 8px; margin: 0; }
        .warranty-info h3 { font-size: 12px; font-weight: 700; color: var(--primary-color); margin: 0 0 4mm 0; text-transform: uppercase; letter-spacing: .4px; }

        .warranty-details { display: grid; grid-template-columns: 1fr 1fr; column-gap: 8mm; row-gap: 3mm; margin: 0; }
        .warranty-detail { text-align: left; font-size: 10px; line-height: 1.45; }
        .warranty-detail strong { color: #374151; display: block; margin-bottom: 1mm; font-size: 9px; text-transform: uppercase; letter-spacing: .3px; }

        .icon-line { display: flex; align-items: center; gap: 6px; }
        .icon { width: 12px; height: 12px; color: var(--primary-color); }

        .warranty-footer {
            margin-top: auto;
            padding-top: 6mm;
            border-top: 1px solid var(--border-color);
            font-size: 10px;
            color: var(--text-secondary);
            text-align: center;
        }

        @media print {
            .warranty-page { padding: 10mm 12mm 10mm 12mm !important; height: 297mm !important; overflow: hidden; }
            .warranty-content h3 { page-break-after: avoid; }
            .warranty-content p, .warranty-content ul { page-break-inside: avoid; }
        }
    </style>
</head>
<body>
    <div class="page-controls no-print">
        <button id="printBtn" class="btn btn-print">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16" style="margin-right:8px">
                <path d="M2 7a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v3h-2v-2H4v2H2V7z"/>
                <path d="M11 2H5v3h6V2z"/>
                <path d="M4 12h8v2H4z"/>
            </svg>
            Imprimer
        </button>
        <button id="returnBtn" class="btn btn-return">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16" style="margin-right:8px">
                <path d="M15 8a.75.75 0 0 1-.75.75H4.56l3.22 3.22a.75.75 0 0 1-1.06 1.06L2.72 8.81a1 1 0 0 1 0-1.62l4-4a.75.75 0 0 1 1.06 1.06L4.56 7.25h9.69A.75.75 0 0 1 15 8z"/>
            </svg>
            Retour
        </button>
    </div>

    <!-- PAGE 1: FACTURE -->
    <div class="page-container">
        <div id="invoice-container" class="container-a4">
            <div class="header">
                <div class="logo-section">
                    {% set _logo = settings.logo or settings.logo_path %}
                    {% if _logo %}<img src="{{ _logo }}" alt="Logo" class="logo">{% endif %}
                    <div class="company-info">
                        {% set _name = settings.company_name or settings.name %}
                        <h1>{{ _name or 'TechPlus' }}</h1>
                        <p>{{ settings.address or '' }}{% if settings.city %}, {{ settings.city }}{% endif %}</p>
                    </div>
                </div>
                <div class="invoice-info">
                    <h2 class="invoice-title">FACTURE</h2>
                    <p class="invoice-number">#{{ invoice.invoice_number }}</p>
                     <p class="invoice-date">Date: {{ invoice.date | format_date }}</p>
                     {% if warranty_certificate %}
                     <p class="invoice-date" style="color: #27ae60; font-weight: 600;">
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" viewBox="0 0 16 16" style="margin-right: 4px;">
                            <path d="M8 0a8 8 0 1 0 0 16A8 8 0 0 0 8 0zM7 3a1 1 0 0 1 2 0v1.07a7.001 7.001 0 0 1 3.274 12.474.5.5 0 0 1-.557-.417A6.001 6.001 0 0 0 14 8c0-1.86-.84-3.52-2.161-4.62A.5.5 0 0 1 12.5 2.5v-1A.5.5 0 0 1 13 1a.5.5 0 0 1 0 1h-.5v.5c0 .28-.22.5-.5.5h-1a.5.5 0 0 1 0-1H12a.5.5 0 0 1 .5-.5V1a.5.5 0 0 1-.5-.5h-1A.5.5 0 0 1 10.5.5V0a.5.5 0 0 1 .5-.5z"/>
                        </svg>
                        Garantie {{ warranty_certificate.duration }} mois
                     </p>
                     {% endif %}
                </div>
            </div>

            <div class="billing">
                <div style="flex:1">
                    <div class="section-title">Facturé à</div>
                    <div class="client-details">
                        {% if invoice.client %}
                        <p><strong>{{ invoice.client.name }}</strong></p>
                        {% if invoice.client.address %}<p>{{ invoice.client.address }}</p>{% endif %}
                        {% if invoice.client.phone %}<p>{{ invoice.client.phone }}</p>{% endif %}
                        {% if invoice.client.email %}<p>{{ invoice.client.email }}</p>{% endif %}
                        {% else %}
                        <p><strong>Client</strong></p>
                        {% endif %}
                    </div>
                </div>
                <div>
                    <div class="section-title">Paiement</div>
                    <div class="payment-box">
                        {% if invoice.due_date %}
                        <div><strong>Échéance:</strong><br/>{{ invoice.due_date | format_date }}</div>
                        {% endif %}
                        {% if resolved_payment_method %}
                        <div style="margin-top:8px"><strong>Mode de paiement:</strong><br/>{{ resolved_payment_method }}</div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <div class="products">
                <div class="products-header">
                    <div>Désignation</div>
                    <div class="text-end">Qté</div>
                    <div class="text-end">PU</div>
                    <div class="text-end">Montant</div>
                </div>
                {% for item in grouped_items %}
                <div class="product-row">
                    <div class="product-name">
                        <div><strong>{{ item.name | replace('\u00a0',' ') | replace(' (IMEI', '<span style="display:none"> (IMEI') | safe }}</strong></div>
                        {% if item.imeis and item.imeis|length %}
                        <div class="imei">{{ item.imeis|join('<br/>')|safe }}</div>
                        {% endif %}
                        
                    </div>
                    <div class="product-qty">
                        {{ item.qty | format_number }}
                        {% if item.quote_qty is not none %}
                            <div class="text-muted" style="font-size:10px">Qté devis: {{ item.quote_qty | format_number }}</div>
                        {% endif %}
                    </div>
                    <div class="product-price">{{ item.price | format_cfa }}</div>
                    <div class="product-total">{{ item.total | format_cfa }}</div>
                </div>
                {% endfor %}
                <!-- Résumé financier directement sous le tableau -->
                <div class="totals">
                    <div class="totals-card">
                        <div class="totals-header">Résumé financier</div>
                        <div class="totals-row"><div class="totals-label">Sous-total</div><div class="totals-value">{{ (invoice.subtotal or 0) | format_cfa }}</div></div>
                        {% if invoice.show_tax %}
                        <div class="totals-row"><div class="totals-label">TVA ({{ (invoice.tax_rate or 0)|round(0, 'common')|int }}%)</div><div class="totals-value">{{ (invoice.tax_amount or 0) | format_cfa }}</div></div>
                        {% endif %}
                    <div class="totals-row grand"><div class="totals-label">Total</div><div class="totals-value">{{ (invoice.total or 0) | format_cfa }}</div></div>
                    {% set _st = (invoice.status or '')|lower %}
                    {% set show_payment_rows = _st in ['partiellement payée', 'partiellement payee', 'partially paid', 'partially_paid'] %}
                    {% if show_payment_rows %}
                    <div class="totals-row"><div class="totals-label">Déjà payé</div><div class="totals-value">{{ (invoice.paid_amount or 0) | format_cfa }}</div></div>
                    <div class="totals-row"><div class="totals-label">Montant dû</div><div class="totals-value">{{ (invoice.remaining_amount or 0) | format_cfa }}</div></div>
                    {% endif %}
                    </div>
                </div>
            </div>

            <!-- Signature juste après le résumé financier -->
            <div style="margin: 14px 24px 0; display:flex; justify-content:flex-end;">
                <div style="min-width:320px; max-width:360px; text-align:center;">
                    <div style="font-size:11px; color:#6b7280; text-transform:uppercase; letter-spacing:.6px; margin-bottom:8px;">Signature</div>
                    {% if signature_data_url %}
                        <img src="{{ signature_data_url }}" alt="Signature" style="max-width: 350px; max-height: 150px; display:block; margin: 0 auto 6px;" />
                        <div style="border-top:1px solid #d1d5db; width: 360px; margin: 6px auto 0; height: 0;"></div>
                    {% else %}
                        <div style="border-bottom:1px solid #d1d5db; width: 240px; height: 46px; margin: 0 auto 0;"></div>
                    {% endif %}
                </div>
            </div>

            <div class="footer">
                <div class="footer-content">
                    <div class="footer-section">
                        <h4>Adresse</h4>
                        <p>{{ settings.address or '' }}{% if settings.city %}, {{ settings.city }}{% endif %}</p>
                    </div>
                    <div class="footer-section">
                        <h4>Contact</h4>
                        {% if settings.phone %}<p>{{ settings.phone }}</p>{% endif %}
                        {% if settings.phone2 %}<p>{{ settings.phone2 }}</p>{% endif %}
                        {% if settings.email %}<p>{{ settings.email }}</p>{% endif %}
                    </div>
                    <div class="footer-section">
                        <h4>Liens</h4>
                        {% if settings.instagram %}<p>@{{ settings.instagram }}</p>{% endif %}
                        {% if settings.website %}<p>{{ settings.website }}</p>{% endif %}
                    </div>
                </div>
                {% if settings.footer_text %}
                <div style="margin-top:8px;color:#6b7280;font-size:11px">{{ settings.footer_text }}</div>
                {% endif %}
            </div>
        </div>
    </div>

    {% if warranty_certificate %}
    <!-- PAGE 2: CERTIFICAT DE GARANTIE -->
    <div class="page-container">
        <div class="warranty-page">
            <!-- En-tête certificat modernisé -->
            <div class="w-watermark">
                {% set _logo = settings.logo or settings.logo_path %}
                {% if _logo %}
                <img src="{{ _logo }}" alt="Watermark">
                {% endif %}
            </div>
            <div class="warranty-hero">
                <div class="w-identity">
                    {% set _logo = settings.logo or settings.logo_path %}
                    {% if _logo %}
                        <img src="{{ _logo }}" alt="Logo" style="max-height:24mm; object-fit:contain;">
                    {% endif %}
                    <div>
                        {% set _name = settings.company_name or settings.name %}
                        <div class="brand">{{ _name or 'TechPlus' }}</div>
                        <div class="address">{{ settings.address or '' }}{% if settings.city %}, {{ settings.city }}{% endif %}</div>
                    </div>
                </div>
                <div style="text-align:right;">
                    <div class="warranty-title">Certificat de Garantie</div>
                    <div class="badge-chip" style="margin-top:4px;">Durée: {{ warranty_certificate.duration }} mois</div>
                </div>
            </div>

            <!-- Bloc détails essentiels -->
            <div class="card" style="margin-top:0;">
                <div class="warranty-section-title">Détails de la garantie</div>
                <div class="warranty-details">
                    <div class="warranty-detail">
                        <strong>Numéro de facture</strong>
                        <div class="icon-line">
                            <svg class="icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M6 2h9l5 5v13a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2z" stroke="currentColor" stroke-width="1.5"/></svg>
                            #{{ warranty_certificate.invoice_number }}
                        </div>
                    </div>
                    <div class="warranty-detail">
                        <strong>Date d'achat</strong>
                        <div class="icon-line">
                            <svg class="icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M7 3v4M17 3v4M3 9h18M5 12h14M5 16h10" stroke="currentColor" stroke-width="1.5"/></svg>
                            {{ warranty_certificate.date | format_date }}
                        </div>
                    </div>
                    <div class="warranty-detail">
                        <strong>Durée de garantie</strong>
                        <div class="icon-line">
                            <svg class="icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 8v5l3 2" stroke="currentColor" stroke-width="1.5"/></svg>
                            {{ warranty_certificate.duration }} mois
                        </div>
                    </div>
                    <div class="warranty-detail">
                        <strong>Début de garantie</strong>
                        <div class="icon-line">
                            <svg class="icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M5 12l5 5L20 7" stroke="currentColor" stroke-width="1.5"/></svg>
                            {{ warranty_certificate.start_date | format_date }}
                        </div>
                    </div>
                    <div class="warranty-detail">
                        <strong>Fin de garantie</strong>
                        <div class="icon-line">
                            <svg class="icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M6 6l12 12M6 18L18 6" stroke="currentColor" stroke-width="1.5"/></svg>
                            {{ warranty_certificate.end_date | format_date }}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Contenu juridique -->
            <div class="warranty-content" style="margin-top:8mm;">
                <div class="grid-2">
                    <div class="card">
                        <h3>Durée de la Garantie</h3>
                <p>
                    La <strong>garantie GeekTechnologie</strong> couvre votre appareil pendant une période de
                    <strong>{{ warranty_certificate.duration }} mois</strong> à compter de la date d'achat. Pendant cette période, nous nous engageons à réparer ou à remplacer votre appareil en cas de dysfonctionnement.
                </p>

                <h3>Étendue de la Garantie</h3>
                <p><strong>Conformité :</strong> Votre appareil doit être conforme à la description fournie lors de l'achat. S'il ne fonctionne pas correctement ou s'il ne correspond pas aux spécifications, nous le réparerons sans frais supplémentaires.</p>
                <p><strong>Vices cachés :</strong> Si des défauts cachés affectent le bon fonctionnement, nous prendrons en charge les réparations nécessaires.</p>
                    </div>
                    <div class="card">
                        <h3>Procédure de Réclamation</h3>
                        <ul>
                            <li><strong>Contact :</strong> Appelez le service client au numéro indiqué sur votre facture d'achat. Nous vous guiderons dans la procédure.</li>
                            <li><strong>Documents :</strong> Présentez votre facture d'achat et toute autre preuve d'achat.</li>
                        </ul>
                        <div class="keyline"></div>
                        <h3>Réparation ou Remplacement</h3>
                        <p>Si votre appareil est défectueux, nous le réparerons ou le remplacerons <strong>conformément à nos conditions de garantie</strong>.</p>
                    </div>
                </div>

                <div class="card" style="margin-top:6mm;">
                    <h3>Exclusions de Garantie</h3>
                    <p>La garantie ne couvre pas les dommages dus à une utilisation inappropriée, une négligence, une chute, une exposition à l'eau ou toute cause étrangère à un défaut de fabrication.</p>
                    <p class="muted small" style="margin-top:2mm;">Chez <strong>GeekTechnologie</strong>, nous sommes fiers de la qualité de nos produits et nous nous engageons à vous offrir une expérience sans souci.</p>
                </div>
            </div>

            <!-- Signature & cachet -->
            <div class="warranty-footer">
                {% set _name = settings.company_name or settings.name %}
                <p><strong>{{ _name or 'TechPlus' }}</strong></p>
                <p>{{ settings.address or '' }}{% if settings.city %}, {{ settings.city }}{% endif %}</p>
                {% if settings.phone %}<p>Tél: {{ settings.phone }}</p>{% endif %}
                {% if settings.email %}<p>Email: {{ settings.email }}</p>{% endif %}

                <div style="margin-top: 6mm; display: flex; justify-content: space-between; align-items: center; gap: 12mm;">
                    <div style="text-align: center; flex:1;">
                        <p style="border-top: 1px solid #ccc; width: 60mm; padding-top: 4mm; margin: 0 auto;">
                            <strong>Signature du Client</strong>
                        </p>
                    </div>
                    <div style="text-align: center; flex:1;">
                        <p style="border-top: 1px solid #ccc; width: 60mm; padding-top: 4mm; margin: 0 auto;">
                            <strong>Cachet de l'Entreprise</strong>
                        </p>
                    </div>
                </div>
            </div>
        </div>
        </div>
    </div>
    {% endif %}

    <script>
        window.onload = function() {
            document.getElementById('printBtn')?.addEventListener('click', function(){ window.print(); });
            document.getElementById('returnBtn')?.addEventListener('click', function(){ window.location.href = '/invoices'; });
            // Auto-print si ouvert en pop-up
            const isInPopup = !!window.opener && window.name === 'invoice_print_popup';
            if (isInPopup) {
                setTimeout(() => window.print(), 400);
            }
        };
        // Fermer la pop-up après impression
        window.onafterprint = function() {
            if (!!window.opener && window.name === 'invoice_print_popup') {
                try { window.close(); } catch(e) {}
            }
        };
    </script>
</body>
</html>