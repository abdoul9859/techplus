<!DOCTYPE html>
<html lang="fr" style="margin:0;padding:0;width:100%;height:100%;">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Devis {{ quotation.quotation_number }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

        :root { --primary-color:#045651; --secondary-color:#045651; --accent-color:#033f3b; --text-primary:#111827; --text-secondary:#6b7280; --border-color:#e5e7eb; --bg-light:#eef6f5; }
        *{box-sizing:border-box;margin:0;padding:0}
        html,body{margin:0!important;padding:0!important;width:100%!important;min-height:100vh!important;background-color:#f5f5f5}
        body{font-family:'Inter',-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;line-height:1.6;font-size:11pt;color:var(--text-primary);display:flex;flex-direction:column;align-items:center;min-height:100vh}
        .page-controls{position:fixed;top:20px;left:0;right:0;display:flex;justify-content:center;gap:10px;z-index:1000}
        .btn-print{background-color:var(--primary-color);color:#fff;border:none}
        .btn-return{background-color:var(--secondary-color);color:#fff;border:none}
        .page-container{display:flex;justify-content:center;align-items:center;padding:80px 0 0;min-height:100vh;width:100%;box-sizing:border-box}
        @media print {
            html, body { width:210mm; height:auto; margin:0 !important; padding:0 !important; overflow:visible; }
            .page-container { padding:0 !important; margin:0 !important; width:210mm; height:auto; }
            #quotation-container { margin:0 !important; padding:0 !important; border:none !important; box-shadow:none !important; width:210mm !important; height:auto !important; transform:none !important; min-height:297mm !important; }
            .no-print { display:none !important; }
            @page { size:A4; margin:0; }
            .products { 
                page-break-inside: auto; 
                margin-top: 0 !important;
                padding-top: 0 !important;
            }
            .product-row { 
                page-break-inside: avoid; 
                break-inside: avoid; 
            }
            .totals { page-break-before: avoid; break-before: avoid; }
            .footer { 
                position: fixed; bottom: 0; left: 0; right: 0; width: 210mm; height: 20mm;
                background: #f8f9fa !important; border-top: 1px solid #e0e0e0; 
                padding: 15px 30px !important; font-size: 10px; z-index: 1000;
                page-break-inside: avoid; break-inside: avoid; margin: 0 !important; box-sizing: border-box;
                -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important;
            }
        }
        .container-a4{width:210mm!important;max-width:210mm!important;min-height:297mm!important;margin:0!important;padding:0!important;background:#fff!important;box-shadow:0 5px 15px rgba(0,0,0,.08);overflow:visible;display:flex;flex-direction:column;position:relative}
        .header{background:linear-gradient(180deg, rgba(4,86,81,0.06), #ffffff 60%);padding:20px 24px 8px;border-bottom:1px solid #e0e0e0;display:flex;justify-content:space-between;align-items:center;width:100%}
        .logo-section{display:flex;align-items:center;gap:16px}
        .logo{max-width:150px;max-height:150px;object-fit:contain}
        .company-info h1{font-size:22px;font-weight:800;margin:0;color:var(--primary-color)}
        .company-info p{margin:2px 0;font-size:11px;color:var(--text-secondary)}
        .company-info{display:flex;flex-direction:column;justify-content:center}
        .invoice-info{text-align:right}
        .invoice-title{font-size:11px;font-weight:700;color:var(--accent-color);margin:0 0 4px 0;letter-spacing:.6px;text-transform:uppercase}
        .invoice-number{display:inline-block;font-size:12px;font-weight:700;color:var(--primary-color);background:var(--bg-light);border:1px solid var(--primary-color);padding:4px 10px;border-radius:9999px;margin:0 0 6px 0}
        .invoice-date{font-size:11px;color:var(--text-secondary);margin:0}
        .billing{display:flex;padding:16px 24px;gap:24px;background:#fff;border-bottom:1px solid var(--border-color);margin:0 20px}
        .section-title{font-size:11px;font-weight:700;text-transform:uppercase;color:var(--text-secondary);margin-bottom:8px;letter-spacing:.5px;border-bottom:2px solid var(--accent-color);padding-bottom:6px;display:inline-block}
        .client-details p{margin:4px 0;font-size:13px;color:var(--text-primary)}
        .info-box{background:var(--bg-light);padding:16px;border-radius:6px;border:1px solid var(--border-color)}
        .products{flex:1;display:flex;flex-direction:column;width:calc(100% - 60px);margin:16px 30px 0;background:#fff;border:1px solid var(--border-color);border-radius:10px;overflow:hidden;box-shadow:0 4px 12px rgba(0,0,0,.04)}
        .products-header{display:flex;background:var(--bg-light);padding:12px 16px;font-size:12px;font-weight:700;color:var(--text-primary);text-transform:uppercase;border-bottom:2px solid var(--primary-color)}
        .product-col{flex:2;text-align:left}
        .qty-col,.price-col{flex:1;text-align:right}
        .product-row{display:flex;padding:12px 16px;border-bottom:1px dashed var(--border-color)}
        .product-row:nth-child(even){background:rgba(4,86,81,0.03)}
        .product-name{flex:2;font-weight:500;font-size:13px;color:var(--text-primary);padding-right:12px}
        .product-qty,.product-price{flex:1;text-align:right;font-size:13px}
        .product-desc{color:#777;font-size:10px;margin-top:3px;text-align:justify}
        .totals{margin:12px 24px 0;display:flex;justify-content:flex-end}
        .totals-card{min-width:320px;max-width:360px;background:#fff;border:1px solid #e5e7eb;border-radius:8px;box-shadow:0 4px 10px rgba(0,0,0,.05);padding:14px 16px}
        .totals-header{font-size:11px;text-transform:uppercase;letter-spacing:.6px;color:var(--text-secondary);margin-bottom:8px}
        .totals-row{display:flex;align-items:center;justify-content:space-between;padding:6px 0}
        .totals-row + .totals-row{border-top:1px dashed #e5e7eb}
        .totals-label{color:#6b7280;font-size:12px}
        .totals-value{color:var(--primary-color);font-weight:700;font-variant-numeric:tabular-nums}
        .totals-row.grand{border-top:2px solid #d1d5db;margin-top:4px;padding-top:10px}
        .totals-row.grand .totals-label{color:#111827;font-weight:700}
        .totals-row.grand .totals-value{color:#111827;font-size:15px}
        .footer{padding:16px 32px;border-top:2px solid var(--primary-color);font-size:11px;width:100%;margin-top:auto;background:var(--bg-light);-webkit-print-color-adjust:exact;print-color-adjust:exact}
        .footer-content{display:grid;grid-template-columns:repeat(4,1fr);align-items:start;gap:24px;max-width:100%;margin:0 auto}
        .footer-section{padding:0 12px;border-left:1px solid var(--border-color)}
        .footer-section:first-child{border-left:none;padding-left:0}
        .footer-section h4{font-size:11px;font-weight:700;color:var(--accent-color);margin:0 0 6px 0;text-transform:uppercase;letter-spacing:.6px}
        .footer-section p{margin:4px 0;color:var(--text-secondary);font-size:11px;line-height:1.5}
        .footer-section i{display:inline-flex;align-items:center;justify-content:center;color:#fff;background:var(--primary-color);margin-right:8px;font-size:10px;width:18px;height:18px;border-radius:50%;text-align:center}
        
        /* Footer fixe pour l'impression */
        @media print {
            .footer { position: fixed; bottom: 0; left: 0; right: 0; width:210mm; height:20mm; background: var(--bg-light) !important; border-top:2px solid var(--primary-color) !important; padding:12px 28px !important; font-size:10px; z-index:1000; page-break-inside:avoid; break-inside:avoid; margin:0 !important; box-sizing:border-box; -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
            .footer-content { display:grid; grid-template-columns: repeat(4,1fr) !important; gap:16px !important; align-items:center; height:100%; padding:0; }
            .footer-section h4 { font-size:10px !important; font-weight:600; color:#333; margin:0 0 3px 0; text-transform:uppercase; }
            .footer-section p { margin:0; color:#666; font-size:9px !important; line-height:1.3 !important; }
        }
        .products{page-break-inside:auto}
        .product-row{page-break-inside:avoid;break-inside:avoid}
        .totals{page-break-before:avoid;break-before:avoid}
        .footer{page-break-inside:avoid;break-inside:avoid}
    </style>
</head>
<body>
    <div class="page-controls no-print">
        <button id="printBtn" class="btn btn-print">Imprimer</button>
        <button id="returnBtn" class="btn btn-return">Retour</button>
    </div>
    <div class="page-container">
        <div id="quotation-container" class="container-a4">
            <div class="header">
                <div class="logo-section">
                    {% set _logo = settings.logo or settings.logo_path %}
                    {% if _logo %}<img src="{{ _logo }}" alt="Logo" class="logo">{% endif %}
                    <div class="company-info">
                        {% set _name = settings.company_name or settings.name %}
                        <h1>{{ _name or 'TechPlus' }}</h1>
                        <p>{{ settings.address or '' }}{% if settings.city %}, {{ settings.city }}{% endif %}</p>
                    </div>
                </div>
                <div class="invoice-info">
                    <h2 class="invoice-title">DEVIS</h2>
                    <p class="invoice-number">#{{ quotation.quotation_number }}</p>
                     <p class="invoice-date">Date: {{ quotation.date | format_date }}</p>
                </div>
            </div>

            <div class="billing">
                <div style="flex:1">
                    <div class="section-title">Devis à</div>
                    <div class="client-details">
                        {% if quotation.client %}
                        <p><strong>{{ quotation.client.name }}</strong></p>
                        {% if quotation.client.address %}<p>{{ quotation.client.address }}</p>{% endif %}
                        {% if quotation.client.phone %}<p>{{ quotation.client.phone }}</p>{% endif %}
                        {% if quotation.client.email %}<p>{{ quotation.client.email }}</p>{% endif %}
                        {% else %}
                        <p><strong>Client</strong></p>
                        {% endif %}
                    </div>
                </div>
                <div style="flex:1">
                    <div class="section-title">Informations</div>
                    <div class="info-box">
                        <div style="font-size:11px;color:var(--text-secondary);text-transform:uppercase">Validité</div>
                        <div style="font-size:16px;font-weight:600;color:var(--primary-color);">{{ quotation.expiry_date | format_date }}</div>
                    </div>
                </div>
            </div>

            <div class="products">
                <div class="products-header">
                    <div class="product-col">Description</div>
                    <div class="qty-col">Qté</div>
                    <div class="price-col">Prix</div>
                </div>
                {% for item in quotation.items %}
                <div class="product-row">
                    <div class="product-name">
                        <div><strong>{{ item.product_name }}</strong></div>
                        
                    </div>
                    <div class="product-qty">{{ item.quantity }}</div>
                    <div class="product-price">{{ (item.price or 0) | format_cfa }}</div>
                </div>
                {% endfor %}

                <div class="totals">
                    <div class="totals-card">
                        <div class="totals-header">Résumé financier</div>
                        <div class="totals-row"><div class="totals-label">Sous-total</div><div class="totals-value">{{ (quotation.subtotal or 0) | format_cfa }}</div></div>
                        {% if (quotation.tax_rate or 0) > 0 %}
                        <div class="totals-row"><div class="totals-label">TVA ({{ (quotation.tax_rate or 0) | int }}%)</div><div class="totals-value">{{ (quotation.tax_amount or 0) | format_cfa }}</div></div>
                        {% endif %}
                        <div class="totals-row grand"><div class="totals-label">Total</div><div class="totals-value">{{ (quotation.total or 0) | format_cfa }}</div></div>
                    </div>
                </div>
            </div>

            {% if signature_data_url %}
            <div style="margin: 14px 24px 0; display:flex; justify-content:flex-end;">
                <div style="min-width:320px; max-width:360px; text-align:center;">
                    <div style="font-size:11px; color:#6b7280; text-transform:uppercase; letter-spacing:.6px; margin-bottom:8px;">Signature</div>
                    <img src="{{ signature_data_url }}" alt="Signature" style="max-width: 220px; max-height: 90px; display:block; margin: 0 auto 6px;" />
                    <div style="border-top:1px solid #d1d5db; width: 240px; margin: 6px auto 0; height: 0;"></div>
                </div>
            </div>
            {% endif %}

            <div class="footer">
                <div class="footer-content">
                    <!-- Section Adresse -->
                    <div class="footer-section">
                        <h4>Adresse</h4>
                        <p><i class="fas fa-map-marker-alt"></i> {{ settings.address if settings and settings.address else 'Ouest Foire, Dakar - Sénégal' }}</p>
                        <p><i class="fas fa-envelope"></i> {{ settings.email if settings and settings.email else 'loucarbusinesspro@gmail.com' }}</p>
                    </div>
                    
                    <!-- Section Contact -->
                    <div class="footer-section">
                        <h4>Contact</h4>
                        <p><i class="fas fa-phone"></i> {{ settings.phone if settings and settings.phone else '77 879 7474' }}</p>
                        {% if settings and settings.phone2 %}
                        <p><i class="fas fa-phone"></i> {{ settings.phone2 }}</p>
                        {% endif %}
                        {% if settings and settings.whatsapp %}
                        <p><i class="fab fa-whatsapp"></i> {{ settings.whatsapp }}</p>
                        {% endif %}
                    </div>
                    
                    <!-- Section Réseaux sociaux -->
                    <div class="footer-section">
                        <h4>Suivez-nous</h4>
                        {% if settings and settings.instagram %}
                        <p><i class="fab fa-instagram"></i> @{{ settings.instagram }}</p>
                        {% endif %}
                        {% if settings and settings.website %}
                        <p><i class="fas fa-globe"></i> {{ settings.website }}</p>
                        {% endif %}
                    </div>
                    
                    <!-- Section Informations légales -->
                    <div class="footer-section">
                        <h4>Informations légales</h4>
                        <p>RC: {{ settings.rc_number if settings and settings.rc_number else 'N/A' }}</p>
                        <p>NINEA: {{ settings.ninea_number if settings and settings.ninea_number else 'N/A' }}</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        window.onload = function(){
            document.getElementById('printBtn')?.addEventListener('click', function(){ window.print(); });
            document.getElementById('returnBtn')?.addEventListener('click', function(){ window.location.href = '/quotations'; });
            const isInPopup = !!window.opener && window.name === 'quotation_print_popup';
            if (isInPopup) { setTimeout(() => window.print(), 400); }
        };
        window.onafterprint = function(){ if (!!window.opener && window.name === 'quotation_print_popup') { try{ window.close(); }catch(e){} } };
    </script>
</body>
</html>


